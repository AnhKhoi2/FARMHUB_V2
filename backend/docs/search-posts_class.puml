@startuml
title FARMHUB – Search for Posts

skinparam monochrome true
skinparam dpi 150
skinparam shadowing false
skinparam packageStyle rectangle
skinparam classAttributeIconSize 0
skinparam defaultFontName Consolas
skinparam linetype ortho
hide circle

' ===== ENUMS (khớp code) =====
enum PostStatus {
  pending
  approved
  rejected
}

' ===== MODELS =====
package "backend/models" {
  class User <<MongooseModel>> {
    +_id: ObjectId
    +username: String
    +email: String
    +role: "user"|"expert"|"moderator"|"admin"
    +isVerified: Boolean
    +isDeleted: Boolean
    +isBanned: Boolean
    +createdAt: Date
    +updatedAt: Date
  }

  class MarketPost <<MongooseModel>> {
    +_id: ObjectId
    +userId: ObjectId -> User {required}
    +title: String {required}
    +description: String
    +phone: String
    +location: Object
    +images: [String] = []
    +status: PostStatus = pending
    +isDeleted: Boolean = false
    +reports: [Report]
    +createdAt: Date
    +updatedAt: Date
  }

  class Report <<Subdocument>> {
    +userId: ObjectId -> User
    +reason: String
    +message: String
    +createdAt: Date
  }
}
MarketPost "1" o- "many" Report : embeds
User "1" <-- "many" MarketPost : author (userId)

' ===== ROUTES =====
package "backend/routes" {
  class PostRoutes <<ExpressRouter>> {
    +GET /api/posts/public        ' public search (no auth)
    +GET /api/posts <<admin>>     ' admin search
  }
}

' ===== CONTROLLER =====
package "backend/controllers" {
  class PostController {
    +listPublic(page?, limit?, q?): Ok<SearchResult>   ' filter: title|description
    +list(page?, limit?, q?): Ok<SearchResult>         ' filter: title|description|phone
    --
    -buildPublicFilter(q?): any   ' { isDeleted:false, $or:[title,description] }
    -buildAdminFilter(q?): any    ' { isDeleted:false, $or:[title,description,phone] }
  }
}

' ===== UTILS =====
package "backend/utils" {
  class ApiResponse {
    +ok(res, data, meta?): Response<200>
    +created(res, data): Response<201>
    +noContent(res): Response<204>
  }
}

' ===== DTOs / VIEW MODELS =====
package "dto" {
  class PostSearchFilter {
    +q?: string
    +page?: number = 1
    +limit?: number = 50
  }

  class SearchMeta {
    +total: number
    +page: number
    +limit: number
  }

  class PostListItem {
    +id: string
    +title: string
    +description?: string
    +thumbnail?: string
    +status: PostStatus
    +createdAt: Date
    +authorUsername?: string
    +authorEmail?: string     ' chỉ có ở admin list()
  }

  class SearchResult {
    +items: PostListItem[]
    +meta: SearchMeta
  }
}

' ===== RELATIONSHIPS (flow) =====
PostRoutes --> PostController : listPublic()\nlist()
PostController --> MarketPost : find(filter)\n.sort({createdAt:-1}).skip().limit()
PostController ..> ApiResponse : ok(res,{items,meta})

' populate differences
note right of PostController
  listPublic():
    populate(userId:'username')
  list():
    populate(userId:'username email')
end note

PostController ..> PostSearchFilter
PostController ..> SearchResult
PostController ..> PostListItem

@enduml

import React, { useState, useEffect } from "react";
import { useNavigate, useParams } from "react-router-dom";
import plantTemplateApi from "../../api/expert/plantTemplateApi";
import {
  Step2Stages,
  Step3Tasks,
  Step4Observations,
  Step5Review,
} from "../../components/expert/TemplateFormSteps";
import "../../css/expert/PlantTemplateForm.css";

const PlantTemplateForm = ({ mode = "create" }) => {
  const navigate = useNavigate();
  const { id } = useParams();
  const [currentStep, setCurrentStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const [formData, setFormData] = useState({
    template_name: "",
    plant_group: "leaf_vegetable",
    group_description: "",
    plant_examples: [],
    stages: [],
    rules: {
      safe_delay_days: 3,
      auto_skip: true,
      warning_days: 1,
    },
    status: "draft",
    notes: "",
  });

  const [tempInput, setTempInput] = useState("");

  const plantGroups = [
    { value: "leaf_vegetable", label: "Rau ƒÉn l√°", icon: "ü•¨" },
    { value: "root_vegetable", label: "C√¢y c·ªß", icon: "ü•ï" },
    { value: "fruit_short_term", label: "Rau/qu·∫£ ng·∫Øn ng√†y", icon: "ü•í" },
    { value: "fruit_long_term", label: "C√¢y ƒÉn qu·∫£ d√†i ng√†y", icon: "üçä" },
    { value: "bean_family", label: "H·ªç ƒë·∫≠u", icon: "ü´ò" },
    { value: "herb", label: "C√¢y gia v·ªã", icon: "üåø" },
    { value: "flower_vegetable", label: "Rau ƒÉn hoa", icon: "ü•¶" },
    { value: "other", label: "Kh√°c", icon: "üå±" },
  ];

  const steps = [
    { number: 1, title: "Th√¥ng tin c∆° b·∫£n", icon: "üìù" },
    { number: 2, title: "Giai ƒëo·∫°n ph√°t tri·ªÉn", icon: "üå±" },
    { number: 3, title: "Nhi·ªám v·ª• t·ª± ƒë·ªông", icon: "‚úÖ" },
    { number: 4, title: "ƒêi·ªÅu ki·ªán quan s√°t", icon: "üëÅÔ∏è" },
    { number: 5, title: "Quy t·∫Øc & X√°c nh·∫≠n", icon: "‚öôÔ∏è" },
  ];

  useEffect(() => {
    if (mode === "edit" && id) {
      loadTemplate();
    }
  }, [mode, id]);

  const loadTemplate = async () => {
    try {
      setLoading(true);
      const response = await plantTemplateApi.getTemplateById(id);
      const template = response.data?.data?.template;
      if (template) {
        setFormData({
          template_name: template.template_name,
          plant_group: template.plant_group,
          group_description: template.group_description || "",
          plant_examples: template.plant_examples || [],
          stages: template.stages || [],
          rules: template.rules || formData.rules,
          status: template.status || "draft",
          notes: template.notes || "",
        });
      }
    } catch (err) {
      console.error("Error loading template:", err);
      setError("Kh√¥ng th·ªÉ t·∫£i template");
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (field, value) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleRuleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      rules: { ...prev.rules, [field]: value },
    }));
  };

  const addPlantExample = () => {
    if (tempInput.trim()) {
      setFormData((prev) => ({
        ...prev,
        plant_examples: [...prev.plant_examples, tempInput.trim()],
      }));
      setTempInput("");
    }
  };

  const removePlantExample = (index) => {
    setFormData((prev) => ({
      ...prev,
      plant_examples: prev.plant_examples.filter((_, i) => i !== index),
    }));
  };

  const addStage = () => {
    const newStageNumber = formData.stages.length + 1;
    const lastStage = formData.stages[formData.stages.length - 1];
    const dayStart = lastStage ? lastStage.day_end + 1 : 1;

    setFormData((prev) => ({
      ...prev,
      stages: [
        ...prev.stages,
        {
          stage_number: newStageNumber,
          name: "",
          description: "",
          day_start: dayStart,
          day_end: dayStart + 6,
          stage_image: null,
          autogenerated_tasks: [],
          observation_required: [],
        },
      ],
    }));
  };

  const updateStage = (index, field, value) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === index ? { ...stage, [field]: value } : stage
      ),
    }));
  };

  const removeStage = (index) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages
        .filter((_, i) => i !== index)
        .map((stage, i) => ({ ...stage, stage_number: i + 1 })),
    }));
  };

  const addTaskToStage = (stageIndex) => {
    const newTask = {
      task_name: "",
      description: "",
      frequency: "daily",
      illustration_image: null,
      priority: "medium",
    };

    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              autogenerated_tasks: [...stage.autogenerated_tasks, newTask],
            }
          : stage
      ),
    }));
  };

  const updateTask = (stageIndex, taskIndex, field, value) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              autogenerated_tasks: stage.autogenerated_tasks.map((task, j) =>
                j === taskIndex ? { ...task, [field]: value } : task
              ),
            }
          : stage
      ),
    }));
  };

  const removeTask = (stageIndex, taskIndex) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              autogenerated_tasks: stage.autogenerated_tasks.filter(
                (_, j) => j !== taskIndex
              ),
            }
          : stage
      ),
    }));
  };

  const addObservationToStage = (stageIndex) => {
    const newObservation = {
      key: "",
      label: "",
      description: "",
    };

    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              observation_required: [
                ...stage.observation_required,
                newObservation,
              ],
            }
          : stage
      ),
    }));
  };

  const updateObservation = (stageIndex, obsIndex, field, value) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              observation_required: stage.observation_required.map((obs, j) =>
                j === obsIndex ? { ...obs, [field]: value } : obs
              ),
            }
          : stage
      ),
    }));
  };

  const removeObservation = (stageIndex, obsIndex) => {
    setFormData((prev) => ({
      ...prev,
      stages: prev.stages.map((stage, i) =>
        i === stageIndex
          ? {
              ...stage,
              observation_required: stage.observation_required.filter(
                (_, j) => j !== obsIndex
              ),
            }
          : stage
      ),
    }));
  };

  const validateStep = (step) => {
    switch (step) {
      case 1:
        if (!formData.template_name.trim()) {
          setError("Vui l√≤ng nh·∫≠p t√™n template");
          return false;
        }
        if (!formData.plant_group) {
          setError("Vui l√≤ng ch·ªçn nh√≥m c√¢y");
          return false;
        }
        break;
      case 2:
        if (formData.stages.length < 3) {
          setError("Template ph·∫£i c√≥ √≠t nh·∫•t 3 giai ƒëo·∫°n");
          return false;
        }
        for (let stage of formData.stages) {
          if (!stage.name.trim()) {
            setError(`Giai ƒëo·∫°n ${stage.stage_number} ch∆∞a c√≥ t√™n`);
            return false;
          }
          if (stage.day_start >= stage.day_end) {
            setError(
              `Giai ƒëo·∫°n ${stage.stage_number}: Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ng√†y k·∫øt th√∫c`
            );
            return false;
          }
        }
        break;
      case 3:
        // Tasks validation (optional)
        break;
      case 4:
        // Observations validation (optional)
        break;
    }
    setError(null);
    return true;
  };

  const nextStep = () => {
    if (validateStep(currentStep)) {
      setCurrentStep((prev) => Math.min(prev + 1, 5));
    }
  };

  const prevStep = () => {
    setCurrentStep((prev) => Math.max(prev - 1, 1));
    setError(null);
  };

  const handleSubmit = async () => {
    if (!validateStep(currentStep)) return;

    try {
      setLoading(true);

      if (mode === "edit") {
        await plantTemplateApi.updateTemplate(id, formData);
        alert("C·∫≠p nh·∫≠t template th√†nh c√¥ng!");
      } else {
        await plantTemplateApi.createTemplate(formData);
        alert("T·∫°o template th√†nh c√¥ng!");
      }

      navigate("/expert/plant-templates");
    } catch (err) {
      console.error("Error saving template:", err);
      setError(err.response?.data?.message || "Kh√¥ng th·ªÉ l∆∞u template");
    } finally {
      setLoading(false);
    }
  };

  if (loading && mode === "edit") {
    return (
      <div className="plant-template-form">
        <div className="loading-container">
          <div className="spinner"></div>
          <p>ƒêang t·∫£i...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="plant-template-form">
      <div className="form-container">
        <div className="form-header">
          <button className="btn-back" onClick={() => navigate(-1)}>
            ‚Üê Quay l·∫°i
          </button>
          <h1>{mode === "edit" ? "Ch·ªânh s·ª≠a" : "T·∫°o m·ªõi"} Plant Template</h1>
        </div>

        {/* Steps Progress */}
        <div className="steps-progress">
          {steps.map((step) => (
            <div
              key={step.number}
              className={`step-item ${
                currentStep === step.number ? "active" : ""
              } ${currentStep > step.number ? "completed" : ""}`}
            >
              <div className="step-number">
                {currentStep > step.number ? "‚úì" : step.icon}
              </div>
              <div className="step-title">{step.title}</div>
            </div>
          ))}
        </div>

        {error && (
          <div className="alert alert-error">
            <span className="icon">‚ö†Ô∏è</span>
            {error}
          </div>
        )}

        {/* Step Content */}
        <div className="step-content">
          {currentStep === 1 && (
            <Step1BasicInfo
              formData={formData}
              handleInputChange={handleInputChange}
              plantGroups={plantGroups}
              tempInput={tempInput}
              setTempInput={setTempInput}
              addPlantExample={addPlantExample}
              removePlantExample={removePlantExample}
            />
          )}

          {currentStep === 2 && (
            <Step2Stages
              stages={formData.stages}
              addStage={addStage}
              updateStage={updateStage}
              removeStage={removeStage}
            />
          )}

          {currentStep === 3 && (
            <Step3Tasks
              stages={formData.stages}
              addTaskToStage={addTaskToStage}
              updateTask={updateTask}
              removeTask={removeTask}
            />
          )}

          {currentStep === 4 && (
            <Step4Observations
              stages={formData.stages}
              addObservationToStage={addObservationToStage}
              updateObservation={updateObservation}
              removeObservation={removeObservation}
            />
          )}

          {currentStep === 5 && (
            <Step5Review
              formData={formData}
              handleRuleChange={handleRuleChange}
              handleInputChange={handleInputChange}
            />
          )}
        </div>

        {/* Navigation Buttons */}
        <div className="form-navigation">
          <button
            className="btn btn-secondary"
            onClick={prevStep}
            disabled={currentStep === 1 || loading}
          >
            ‚Üê Quay l·∫°i
          </button>

          <div className="nav-info">
            B∆∞·ªõc {currentStep} / {steps.length}
          </div>

          {currentStep < 5 ? (
            <button className="btn btn-primary" onClick={nextStep}>
              Ti·∫øp theo ‚Üí
            </button>
          ) : (
            <button
              className="btn btn-success"
              onClick={handleSubmit}
              disabled={loading}
            >
              {loading
                ? "ƒêang l∆∞u..."
                : mode === "edit"
                ? "C·∫≠p nh·∫≠t"
                : "T·∫°o template"}
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// Step 1: Basic Info Component
const Step1BasicInfo = ({
  formData,
  handleInputChange,
  plantGroups,
  tempInput,
  setTempInput,
  addPlantExample,
  removePlantExample,
}) => (
  <div className="step-basic-info">
    <h2>Th√¥ng tin c∆° b·∫£n</h2>

    <div className="form-group">
      <label>
        T√™n Template <span className="required">*</span>
      </label>
      <input
        type="text"
        className="form-input"
        placeholder="V√≠ d·ª•: Rau ƒÉn l√° c∆° b·∫£n"
        value={formData.template_name}
        onChange={(e) => handleInputChange("template_name", e.target.value)}
      />
    </div>

    <div className="form-group">
      <label>
        Nh√≥m c√¢y <span className="required">*</span>
      </label>
      <div className="plant-groups-grid">
        {plantGroups.map((group) => (
          <div
            key={group.value}
            className={`group-card ${
              formData.plant_group === group.value ? "selected" : ""
            }`}
            onClick={() => handleInputChange("plant_group", group.value)}
          >
            <div className="group-icon">{group.icon}</div>
            <div className="group-label">{group.label}</div>
          </div>
        ))}
      </div>
    </div>

    <div className="form-group">
      <label>M√¥ t·∫£ nh√≥m c√¢y</label>
      <textarea
        className="form-textarea"
        rows="3"
        placeholder="M√¥ t·∫£ v·ªÅ nh√≥m c√¢y n√†y..."
        value={formData.group_description}
        onChange={(e) => handleInputChange("group_description", e.target.value)}
      />
    </div>

    <div className="form-group">
      <label>V√≠ d·ª• c√¢y thu·ªôc nh√≥m</label>
      <div className="input-with-button">
        <input
          type="text"
          className="form-input"
          placeholder="Nh·∫≠p t√™n c√¢y, v√≠ d·ª•: X√† l√°ch"
          value={tempInput}
          onChange={(e) => setTempInput(e.target.value)}
          onKeyPress={(e) => e.key === "Enter" && addPlantExample()}
        />
        <button
          type="button"
          className="btn btn-sm btn-primary"
          onClick={addPlantExample}
        >
          Th√™m
        </button>
      </div>

      {formData.plant_examples.length > 0 && (
        <div className="tags-list">
          {formData.plant_examples.map((example, index) => (
            <span key={index} className="tag">
              {example}
              <button
                type="button"
                className="tag-remove"
                onClick={() => removePlantExample(index)}
              >
                √ó
              </button>
            </span>
          ))}
        </div>
      )}
    </div>
  </div>
);

// Continue with other step components in next file...
export default PlantTemplateForm;

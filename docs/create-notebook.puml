@startuml Create_Notebook_Class_Diagram
title Create Notebook Class Diagram â€“ Farmer Flow (Full Model Fields)

skinparam classAttributeIconSize 0
skinparam shadowing false
skinparam backgroundColor #FFFFFF

' === STYLE ===
skinparam class {
  BackgroundColor #FFFFFF
  BorderColor #333333
  ArrowColor #333333
}
skinparam stereotypeCBackgroundColor #E8F6F3
skinparam stereotypeCBorderColor #117A65
skinparam stereotypeCFontColor #117A65

' === CLASSES ===
class NotebookRouter <<router>> {
 - router: Router
 --
 // All notebook routes require authentication
 // router.use(verifyToken)
 // POST /notebooks -> notebookController.createNotebook
 router.use(verifyToken)
 router.post(
   "/",
   notebookController.createNotebook
 )
}

class NotebookController <<controller>> {
 --
 + createNotebook(req, res)
 + validateCreatePayload(data)
}

' NOTE: There is no NotebookService in the current codebase.
' Controller contains the creation + template assignment logic directly.

class NotebookModel <<model>> {
 - _id : ObjectId
 - user_id : ObjectId
 - guide_id : ObjectId
 - template_id : ObjectId
 - notebook_name : String
 - plant_type : String
 - plant_group : String
 - planted_date : Date
 - planted_date_vn : String
 - cover_image : String
 - description : String
 - progress : Number
 - images : [String]
 - status : String
 - deletedAt : Date
 - current_stage : Number
 - stages_tracking : Array
 - daily_checklist : Array
 - last_checklist_generated : Date
 - last_checklist_generated_vn : String
 - days_planted : Number
 - createdAt : Date
 - updatedAt : Date
 --
 + updateProgress(templateStages)
 + getCurrentStageCompletion()
}

class StageTracking <<model>> {
 - stage_number : Number
 - stage_name : String
 - started_at : Date
 - completed_at : Date
 - is_current : Boolean
 - status : String
 - completed_tasks : Array
 - observations : Array
 - daily_logs : Array
 - overdue_tasks : Array
 - overdue_summary : Object
 - pending_transition : Boolean
 - transition_date : Date
}

class DailyChecklistItem <<model>> {
 - task_name : String
 - description : String
 - is_completed : Boolean
 - completed_at : Date
 - priority : String
 - frequency : String
 - status : String
 - overdue_at : Date
}

class GuideModel <<model>> {
 - _id : ObjectId
 - expert_id : ObjectId
 - title : String
 - description : String
 - content : String
 - tags : [String]
 - image : String
 - steps : Array
 - plantTags : [String]
 - plant_group : String
 - plant_group_id : ObjectId
 - plant_name : String
 - deleted : Boolean
 - deletedAt : Date
 - status : String
 - createdAt : Date
 - updatedAt : Date
}

class PlantTemplateModel <<model>> {
 - _id : ObjectId
 - template_name : String
 - plant_group : String
 - group_description : String
 - plant_examples : [String]
 - cover_image : String
 - stages : Array
 - status : String
 - created_by : ObjectId
 - version : Number
 - notes : String
 - usage_count : Number
 - createdAt : Date
 - updatedAt : Date
}

class AutoGeneratedTask <<model>> {
 - task_name : String
 - description : String
 - frequency : String
 - illustration_image : String
 - priority : String
}

class ObservationSchema <<model>> {
 - key : String
 - label : String
 - description : String
}

class StageSchema <<model>> {
 - stage_number : Number
 - name : String
 - description : String
 - day_start : Number
 - day_end : Number
 - weight : Number
 - stage_image : String
 - autogenerated_tasks : Array
 - observation_required : Array
}

class UserModel <<model>> {
 - _id : ObjectId
 - username : String
 - email : String
 - password : String
 - avatar : String
 - provider : String
 - googleId : String
 - role : String
 - isVerified : Boolean
 - isDeleted : Boolean
 - refreshTokens : [String]
 - verifyEmailCount : Number
 - lastVerifyEmailAt : Date
 - acceptedTerms : Boolean
 - acceptedTermsAt : Date
 - subscriptionPlan : String
 - subscriptionExpires : Date
 - createdAt : Date
 - updatedAt : Date
}

class AuthMiddleware <<middleware>> {
 userModel : UserModel
 --
 + verifyToken(req, res, next)
 + requireRole(...roles)
}

class MulterUtil <<utility>> {
 - uploadNotebookCover : Multer
 --
 + ensureDirectoryExists(dir)
 + imageFileFilter(req, file, cb)
}

class NotificationController <<controller>> {
 --
 + sendDailyReminderNotification(user, notebook)
 + notifyNotebookCreated(user, notebook)
}

' === RELATIONSHIPS ===
NotebookRouter ..> NotebookController : "<<uses>>"
NotebookRouter ..> AuthMiddleware : "<<uses>>"
NotebookRouter ..> MulterUtil : "<<uses>>"
NotebookController ..> NotebookModel : "<<uses>>"
NotebookController ..> GuideModel : "<<uses>>"
NotebookController ..> UserModel : "<<uses>>"
NotebookController ..> NotificationController : "<<uses>>"

' Explicit sub-schema links
NotebookModel --> StageTracking : "stages_tracking (Array)"
NotebookModel --> DailyChecklistItem : "daily_checklist (Array)"
PlantTemplateModel --> StageSchema : "stages (Array)"
StageSchema --> AutoGeneratedTask : "autogenerated_tasks (Array)"
StageSchema --> ObservationSchema : "observation_required (Array)"
StageTracking --> ObservationSchema : "observations (Array)"

AuthMiddleware ..> UserModel : "<<uses>>"

@enduml
